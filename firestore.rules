/**
 * @fileoverview Firestore Security Rules for Aravalli Home Studio.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for customer profiles and their associated order data.
 * Product, GalleryItem, and Greeting data are publicly readable, but write access is not defined in this configuration and thus implicitly denied.
 *
 * Data Structure:
 * - /products/{productId}: Public product catalog.
 * - /users/{userId}: User profiles, where userId is the Firebase Auth UID.
 * - /users/{userId}/orders/{orderId}: Orders placed by a specific user.
 * - /users/{userId}/orders/{orderId}/orderItems/{orderItemId}: Items within a specific order.
 * - /galleryItems/{galleryItemId}: Public gallery of images and videos.
 * - /greetings/{greetingId}: Global greeting messages.
 *
 * Key Security Decisions:
 * - User listing is disallowed for privacy.
 * - Public read access is granted for products and gallery items.
 * - Write access to Greetings collection are implicitly denied.
 *
 * Denormalization for Authorization:
 * - Order documents are nested under the user and include `customerId` to enforce ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to product information. Write access is implicitly denied.
     * @path /products/{productId}
     * @allow (get, list) Any user can read product information.
     * @deny (create, update, delete) No user can create, update, or delete product information.
     * @principle Public read access with no write access.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Enforces ownership for user profiles. Only the authenticated user can read or write their own profile.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' can create /users/user_abc if request.auth.uid == 'user_abc'.
     * @allow (get, update, delete) User with UID 'user_abc' can get, update, or delete /users/user_abc if request.auth.uid == 'user_abc'.
     * @deny (create) User with UID 'user_xyz' cannot create /users/user_abc.
     * @deny (get, update, delete) User with UID 'user_xyz' cannot get, update, or delete /users/user_abc.
     * @deny (list) No user can list all user profiles.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces ownership for orders. Only the owner user can read, create, update, or delete their own orders.
     * @path /users/{userId}/orders/{orderId}
     * @allow (create) User with UID 'user_abc' can create /users/user_abc/orders/order_123.
     * @allow (get, update, delete) User with UID 'user_abc' can get, update, or delete /users/user_abc/orders/order_123.
     * @deny (create) User with UID 'user_xyz' cannot create /users/user_abc/orders/order_123.
     * @deny (get, update, delete) User with UID 'user_xyz' cannot get, update, or delete /users/user_abc/orders/order_123.
     * @principle Enforces document ownership for writes; allows owner-only reads.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces ownership for order items. Only the owner user can read, create, update, or delete their own order items.
     * @path /users/{userId}/orders/{orderId}/orderItems/{orderItemId}
     * @allow (create) User with UID 'user_abc' can create /users/user_abc/orders/order_123/orderItems/item_456.
     * @allow (get, update, delete) User with UID 'user_abc' can get, update, or delete /users/user_abc/orders/order_123/orderItems/item_456.
     * @deny (create) User with UID 'user_xyz' cannot create /users/user_abc/orders/order_123/orderItems/item_456.
     * @deny (get, update, delete) User with UID 'user_xyz' cannot get, update, or delete /users/user_abc/orders/order_123/orderItems/item_456.
     * @principle Enforces document ownership for writes; allows owner-only reads.
     */
    match /users/{userId}/orders/{orderId}/orderItems/{orderItemId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to gallery items. Write access is implicitly denied.
     * @path /galleryItems/{galleryItemId}
     * @allow (get, list) Any user can read gallery item information.
     * @deny (create, update, delete) No user can create, update, or delete gallery item information.
     * @principle Public read access with no write access.
     */
    match /galleryItems/{galleryItemId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to greeting messages. Write access is implicitly denied.
     * @path /greetings/{greetingId}
     * @allow (get, list) Any user can read greeting messages.
     * @deny (create, update, delete) No user can create, update, or delete greeting messages.
     * @principle Public read access with no write access.
     */
    match /greetings/{greetingId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}