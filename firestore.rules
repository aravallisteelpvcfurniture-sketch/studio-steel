/**
 * @fileoverview Firestore Security Rules for Aravalli Home Studio.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for customer data (profiles, orders, recommendations),
 * while allowing public read access to product and gallery information.  Write access to customer-owned
 * data is restricted to the authenticated user matching the `customerId` path segment.
 *
 * Data Structure:
 * - /products/{productId}: Publicly readable product catalog.
 * - /customers/{customerId}: Customer profiles, accessible only by the owning customer.
 * - /customers/{customerId}/orders/{orderId}: Orders belonging to a specific customer.
 * - /customers/{customerId}/orders/{orderId}/orderItems/{orderItemId}: Items within a specific order.
 * - /galleryItems/{galleryItemId}: Publicly readable gallery items (images, videos).
 * - /customers/{customerId}/recommendations/{recommendationId}: Product recommendations for a customer.
 *
 * Key Security Decisions:
 * - Customers can only access their own data (profiles, orders, recommendations).
 * - Products and gallery items are publicly readable.
 * - No administrative roles are defined, so write access to Products and GalleryItems is denied.
 * - Data validation is limited to ensuring ownership and relational integrity.  Data shapes are NOT validated.
 *
 * Denormalization for Authorization:
 * - Ownership is enforced through path-based rules (e.g., `/customers/{customerId}`).
 *   This avoids the need for `get()` calls to verify ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to product information. Write access is denied.
     * @path /products/{productId}
     * @allow (get, list): Any user (or no user) can read product data.
     * @deny (create, update, delete): No user can create, update, or delete product data.
     * @principle Allows public read access and restricts write access.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows a customer to read and write their own profile data.
     * @path /customers/{customerId}
     * @allow (create): A user can create their own profile if the customerId matches their auth UID.
     * @allow (get, update, delete): A user can get, update, and delete their own profile if the customerId matches their auth UID.
     * @deny (create, get, update, delete): A user cannot create, get, update, or delete another user's profile.
     * @principle Enforces document ownership for customer profiles.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows a customer to read and write their own orders.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (create): A user can create an order under their customer ID.
     * @allow (get, update, delete): A user can get, update, and delete their own order.
     * @deny (create, get, update, delete): A user cannot create, get, update, or delete another user's order.
     * @principle Enforces document ownership for customer orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows a customer to read and write their own order items.
     * @path /customers/{customerId}/orders/{orderId}/orderItems/{orderItemId}
     * @allow (create): A user can create an order item under their customer ID and order ID.
     * @allow (get, update, delete): A user can get, update, and delete their own order item.
     * @deny (create, get, update, delete): A user cannot create, get, update, or delete another user's order item.
     * @principle Enforces document ownership for customer order items.
     */
    match /customers/{customerId}/orders/{orderId}/orderItems/{orderItemId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows public read access to gallery items. Write access is denied.
     * @path /galleryItems/{galleryItemId}
     * @allow (get, list): Any user (or no user) can read gallery item data.
     * @deny (create, update, delete): No user can create, update, or delete gallery item data.
     * @principle Allows public read access and restricts write access.
     */
    match /galleryItems/{galleryItemId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows a customer to read and write their own recommendations.
     * @path /customers/{customerId}/recommendations/{recommendationId}
     * @allow (create): A user can create a recommendation under their customer ID.
     * @allow (get, update, delete): A user can get, update, and delete their own recommendation.
     * @deny (create, get, update, delete): A user cannot create, get, update, or delete another user's recommendation.
     * @principle Enforces document ownership for customer recommendations.
     */
    match /customers/{customerId}/recommendations/{recommendationId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource based on the provided userId.
     * @param {string} userId The user ID to compare with the request's auth UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the existing owner of the resource based on the provided userId, and that the resource exists.
     * @param {string} userId The user ID to compare with the request's auth UID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}